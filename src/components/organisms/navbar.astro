---
// Navbar organism component using design system
import Container from '../atoms/container.astro';
import Button from '../atoms/button.astro';
import Icon from '../atoms/icon.astro';
import type { Locale } from '../../types/i18n';
import { t, loadTranslations } from '../../utils/i18n';

export interface Props {
  locale: Locale;
  currentPath?: string;
  variant?: 'default' | 'transparent' | 'solid';
  sticky?: boolean;
  class?: string;
}

const {
  locale,
  currentPath = '',
  variant = 'default',
  sticky = true,
  class: className = '',
} = Astro.props;

const translations = await loadTranslations(locale);

// Navigation structure for Salut Annecy
const navItems = [
  { 
    key: 'nav.home', 
    href: `/${locale}`,
    icon: 'home'
  },
  { 
    key: 'nav.discover', 
    href: '#',
    icon: 'search',
    submenu: [
      { key: 'nav.restaurants', href: `/${locale}/restaurants`, icon: 'utensils' },
      { key: 'nav.hebergements', href: `/${locale}/hebergements`, icon: 'bed' },
      { key: 'nav.activites', href: `/${locale}/activites`, icon: 'activity' },
      { key: 'nav.evenements', href: `/${locale}/evenements`, icon: 'calendar' },
      { key: 'nav.articles', href: `/${locale}/articles`, icon: 'file-text' }
    ]
  },
  { 
    key: 'nav.community', 
    href: '#',
    icon: 'users',
    submenu: [
      { key: 'nav.forums', href: `/${locale}/forums`, icon: 'message-circle' },
      { key: 'nav.groupes', href: `/${locale}/groupes`, icon: 'users' },
      { key: 'nav.membres', href: `/${locale}/membres`, icon: 'user' }
    ]
  },
  { 
    key: 'nav.annonces', 
    href: `/${locale}/annonces`,
    icon: 'briefcase',
    submenu: [
      { key: 'nav.emploi', href: `/${locale}/annonces/emploi`, icon: 'briefcase' },
      { key: 'nav.immobilier', href: `/${locale}/annonces/immobilier`, icon: 'home' },
      { key: 'nav.vente', href: `/${locale}/annonces/vente`, icon: 'shopping-bag' },
      { key: 'nav.services_particuliers', href: `/${locale}/annonces/services`, icon: 'tool' }
    ]
  }
];

const classes = [
  'navbar',
  `navbar--${variant}`,
  sticky && 'navbar--sticky',
  className
].filter(Boolean).join(' ');
---

<nav class={classes} role="navigation" aria-label="Main navigation">
  <Container size="xl" padding="md">
    <div class="navbar__content">
      <!-- Logo/Brand -->
      <div class="navbar__brand">
        <a href={`/${locale}`} class="navbar__logo">
          <Icon name="map" size="lg" color="primary" />
          <span class="navbar__brand-text">Salut Annecy</span>
        </a>
      </div>

      <!-- Desktop Navigation -->
      <div class="navbar__nav navbar__nav--desktop">
        <ul class="navbar__menu">
          {navItems.map((item) => (
            <li class="navbar__item">
              <a 
                href={item.href} 
                class={`navbar__link ${currentPath === item.href ? 'navbar__link--active' : ''}`}
                aria-haspopup={item.submenu ? 'true' : 'false'}
                aria-expanded={item.submenu ? 'false' : undefined}
              >
                <Icon name={item.icon} size="sm" />
                {t(translations, item.key)}
                {item.submenu && <Icon name="chevron-down" size="xs" />}
              </a>
              
              {item.submenu && (
                <div class="navbar__submenu">
                  <ul class="navbar__submenu-list">
                    {item.submenu.map((subItem) => (
                      <li class="navbar__submenu-item">
                        <a 
                          href={subItem.href} 
                          class={`navbar__submenu-link ${currentPath === subItem.href ? 'navbar__submenu-link--active' : ''}`}
                        >
                          <Icon name={subItem.icon} size="sm" />
                          {t(translations, subItem.key)}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </li>
          ))}
        </ul>
      </div>

      <!-- User Actions -->
      <div class="navbar__actions">
        <!-- Theme Toggle -->
        <button class="navbar__theme-toggle" id="theme-toggle" aria-label="Toggle theme">
          <Icon name="sun" size="sm" class="theme-icon theme-icon--light" />
          <Icon name="moon" size="sm" class="theme-icon theme-icon--dark" />
        </button>

        <!-- Search -->
        <Button variant="ghost" size="sm" class="navbar__search-btn">
          <Icon name="search" size="sm" />
          <span class="sr-only">Search</span>
        </Button>

        <!-- Auth Buttons -->
        <div class="navbar__auth">
          <Button variant="ghost" size="sm" href={`/${locale}/auth/login`}>
            {t(translations, 'auth.login')}
          </Button>
          <Button variant="primary" size="sm" href={`/${locale}/auth/register`}>
            {t(translations, 'auth.register')}
          </Button>
        </div>

        <!-- Mobile Menu Toggle -->
        <button class="navbar__mobile-toggle" aria-label="Toggle mobile menu" aria-expanded="false">
          <Icon name="menu" size="md" class="mobile-icon mobile-icon--menu" />
          <Icon name="close" size="md" class="mobile-icon mobile-icon--close" />
        </button>
      </div>

      <!-- Mobile Navigation -->
      <div class="navbar__nav navbar__nav--mobile">
        <ul class="navbar__mobile-menu">
          {navItems.map((item) => (
            <li class="navbar__mobile-item">
              <a 
                href={item.href} 
                class={`navbar__mobile-link ${currentPath === item.href ? 'navbar__mobile-link--active' : ''}`}
              >
                <Icon name={item.icon} size="sm" />
                {t(translations, item.key)}
              </a>
              
              {item.submenu && (
                <ul class="navbar__mobile-submenu">
                  {item.submenu.map((subItem) => (
                    <li class="navbar__mobile-submenu-item">
                      <a 
                        href={subItem.href} 
                        class={`navbar__mobile-submenu-link ${currentPath === subItem.href ? 'navbar__mobile-submenu-link--active' : ''}`}
                      >
                        <Icon name={subItem.icon} size="sm" />
                        {t(translations, subItem.key)}
                      </a>
                    </li>
                  ))}
                </ul>
              )}
            </li>
          ))}
          
          <!-- Mobile Auth Links -->
          <li class="navbar__mobile-item navbar__mobile-item--auth">
            <a href={`/${locale}/auth/login`} class="navbar__mobile-link">
              <Icon name="log-in" size="sm" />
              {t(translations, 'auth.login')}
            </a>
          </li>
          <li class="navbar__mobile-item navbar__mobile-item--auth">
            <a href={`/${locale}/auth/register`} class="navbar__mobile-link">
              <Icon name="user-plus" size="sm" />
              {t(translations, 'auth.register')}
            </a>
          </li>
        </ul>
      </div>
    </div>
  </Container>
</nav>

<script>
  // Theme toggle functionality
  function initThemeToggle() {
    const themeToggle = document.getElementById('theme-toggle');
    const html = document.documentElement;
    
    if (!themeToggle) return;
    
    themeToggle.addEventListener('click', () => {
      const currentTheme = html.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', JSON.stringify(newTheme));
    });
  }

  // Mobile menu toggle
  function initMobileMenu() {
    const mobileToggle = document.querySelector('.navbar__mobile-toggle');
    const mobileNav = document.querySelector('.navbar__nav--mobile');
    
    if (!mobileToggle || !mobileNav) return;
    
    mobileToggle.addEventListener('click', () => {
      const isExpanded = mobileToggle.getAttribute('aria-expanded') === 'true';
      
      mobileToggle.setAttribute('aria-expanded', (!isExpanded).toString());
      mobileNav.classList.toggle('navbar__nav--mobile-open');
      document.body.classList.toggle('navbar-mobile-open');
    });
    
    // Close mobile menu on outside click
    document.addEventListener('click', (e) => {
      const target = e.target as Node;
      if (!mobileToggle?.contains(target) && !mobileNav?.contains(target)) {
        mobileToggle?.setAttribute('aria-expanded', 'false');
        mobileNav?.classList.remove('navbar__nav--mobile-open');
        document.body.classList.remove('navbar-mobile-open');
      }
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    initThemeToggle();
    initMobileMenu();
  });
</script>

<style>
  .navbar {
    background-color: var(--bg-surface);
    border-bottom: 1px solid var(--border-primary);
    transition: var(--transition-all);
    z-index: var(--z-sticky);
  }

  .navbar--sticky {
    position: sticky;
    top: 0;
  }

  .navbar--transparent {
    background-color: transparent;
    border-bottom: none;
  }

  .navbar--solid {
    background-color: var(--bg-surface);
    box-shadow: var(--shadow-sm);
  }

  .navbar__content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-height: 64px;
    gap: var(--space-6);
  }

  /* Brand/Logo */
  .navbar__brand {
    flex-shrink: 0;
  }

  .navbar__logo {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    text-decoration: none;
    color: var(--text-primary);
    font-weight: var(--font-weight-bold);
    font-size: var(--font-size-lg);
    transition: var(--transition-colors);
  }

  .navbar__logo:hover {
    color: var(--color-accent);
  }

  .navbar__brand-text {
    display: none;
  }

  /* Desktop Navigation */
  .navbar__nav--desktop {
    display: none;
    flex: 1;
  }

  .navbar__menu {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .navbar__item {
    position: relative;
  }

  .navbar__link {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: var(--radius-base);
    transition: var(--transition-all);
    font-weight: var(--font-weight-medium);
    font-size: var(--font-size-sm);
  }

  .navbar__link:hover,
  .navbar__link--active {
    color: var(--color-accent);
    background-color: var(--bg-secondary);
  }

  /* Submenu */
  .navbar__submenu {
    position: absolute;
    top: 100%;
    left: 0;
    min-width: 220px;
    background-color: var(--bg-surface);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: var(--transition-all);
    z-index: var(--z-dropdown);
  }

  .navbar__item:hover .navbar__submenu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .navbar__submenu-list {
    list-style: none;
    margin: 0;
    padding: var(--space-2);
  }

  .navbar__submenu-link {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: var(--radius-base);
    transition: var(--transition-all);
    font-size: var(--font-size-sm);
  }

  .navbar__submenu-link:hover,
  .navbar__submenu-link--active {
    color: var(--color-accent);
    background-color: var(--bg-secondary);
  }

  /* Actions */
  .navbar__actions {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .navbar__theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border: none;
    background: none;
    color: var(--text-secondary);
    border-radius: var(--radius-base);
    cursor: pointer;
    transition: var(--transition-all);
    position: relative;
  }

  .navbar__theme-toggle:hover {
    color: var(--color-accent);
    background-color: var(--bg-secondary);
  }

  .theme-icon {
    position: absolute;
    transition: var(--transition-all);
  }

  [data-theme="light"] .theme-icon--dark,
  [data-theme="dark"] .theme-icon--light {
    opacity: 0;
    transform: rotate(180deg);
  }

  [data-theme="light"] .theme-icon--light,
  [data-theme="dark"] .theme-icon--dark {
    opacity: 1;
    transform: rotate(0deg);
  }

  .navbar__auth {
    display: none;
    align-items: center;
    gap: var(--space-2);
  }

  .navbar__search-btn {
    display: none;
  }

  /* Mobile Menu */
  .navbar__mobile-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border: none;
    background: none;
    color: var(--text-secondary);
    border-radius: var(--radius-base);
    cursor: pointer;
    transition: var(--transition-all);
    position: relative;
  }

  .navbar__mobile-toggle:hover {
    color: var(--color-accent);
    background-color: var(--bg-secondary);
  }

  .mobile-icon {
    position: absolute;
    transition: var(--transition-all);
  }

  .navbar__mobile-toggle[aria-expanded="false"] .mobile-icon--close,
  .navbar__mobile-toggle[aria-expanded="true"] .mobile-icon--menu {
    opacity: 0;
    transform: rotate(180deg);
  }

  .navbar__mobile-toggle[aria-expanded="false"] .mobile-icon--menu,
  .navbar__mobile-toggle[aria-expanded="true"] .mobile-icon--close {
    opacity: 1;
    transform: rotate(0deg);
  }

  .navbar__nav--mobile {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: var(--bg-surface);
    border-top: 1px solid var(--border-primary);
    box-shadow: var(--shadow-lg);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-16px);
    transition: var(--transition-all);
    z-index: var(--z-dropdown);
    max-height: calc(100vh - 64px);
    overflow-y: auto;
  }

  .navbar__nav--mobile-open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .navbar__mobile-menu {
    list-style: none;
    margin: 0;
    padding: var(--space-4);
  }

  .navbar__mobile-item {
    border-bottom: 1px solid var(--border-primary);
  }

  .navbar__mobile-item:last-child {
    border-bottom: none;
  }

  .navbar__mobile-link {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4);
    color: var(--text-secondary);
    text-decoration: none;
    transition: var(--transition-colors);
    font-weight: var(--font-weight-medium);
  }

  .navbar__mobile-link:hover,
  .navbar__mobile-link--active {
    color: var(--color-accent);
  }

  .navbar__mobile-submenu {
    list-style: none;
    margin: 0;
    padding: 0 0 0 var(--space-8);
    background-color: var(--bg-secondary);
  }

  .navbar__mobile-submenu-link {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    color: var(--text-tertiary);
    text-decoration: none;
    transition: var(--transition-colors);
    font-size: var(--font-size-sm);
  }

  .navbar__mobile-submenu-link:hover,
  .navbar__mobile-submenu-link--active {
    color: var(--color-accent);
  }

  .navbar__mobile-item--auth {
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--border-primary);
    border-bottom: none;
  }

  /* Responsive breakpoints */
  @media (min-width: 768px) {
    .navbar__brand-text {
      display: block;
    }

    .navbar__nav--desktop {
      display: block;
    }

    .navbar__search-btn {
      display: flex;
    }

    .navbar__mobile-toggle {
      display: none;
    }
  }

  @media (min-width: 1024px) {
    .navbar__auth {
      display: flex;
    }
  }

  /* Prevent body scroll when mobile menu is open */
  .navbar-mobile-open {
    overflow: hidden;
  }

  /* Screen reader only class */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>